import React, { useState, useEffect, useMemo } from 'react';
import axios from 'axios';
import './styles/Posts.css';

const Posts = () => {
    const [postCount, setPostCount] = useState(5);
    const [posts, setPosts] = useState([]);
    const [error, setError] = useState(null);
    const [loading, setLoading] = useState(false);
    const [useAxios, setUseAxios] = useState(true);

    // const fetchPostsWithFetch = async () => {
    //     try {
    //         setLoading(true);
    //         const response = await fetch('https://jsonplaceholder.typicode.com/posts');
    //         if (!response.ok) {
    //             throw new Error('Network response was not ok');
    //         }
    //         const data = await response.json();
    //         setPosts(data);
    //         setError(null);
    //     } catch (err) {
    //         setError(err.message);
    //     } finally {
    //         setLoading(false);
    //     }
    // }

    // const fetchPostsWithAxios = async () => {
    //     try {
    //         setLoading(true);
    //         const response = await axios.get('https://jsonplaceholder.typicode.com/posts');
    //         setPosts(response.data);
    //         setError(null);
    //     } catch (err) {
    //         setError(err.message);
    //     } finally {
    //         setLoading(false);
    //     }
    // };

    const fetchPosts = async () => {
        try {
            setLoading(true);
            const response = await axios.get(`${API_BASE_URL}/posts?limit=${postCount}`);
            setPosts(response.data);
            setError(null);
        } catch (err) {
            setError(err.message);
            console.error('Error fetching posts:', err);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        if (useAxios) {
            fetchPostsWithAxios();
        } else {
            fetchPostsWithFetch();
        }
    }, [useAxios]);

    const displayedPosts = useMemo(() => {
        return posts.slice(0, postCount);
    }, [posts, postCount]);
    
    const reloadPosts = () => {
        if (useAxios) {
        fetchPostsWithAxios();
        } else {
        fetchPostsWithFetch();
        }
    };

    return(
        <div className="posts-container">
        <h1>Посты</h1>
        
        <div className="posts-controls">
            <div className="slider-container">
            <label htmlFor="postCount">
                Количество постов: {postCount}
            </label>
            <input
                id="postCount"
                type="range"
                min="1"
                max="20"
                value={postCount}
                onChange={(e) => setPostCount(Number(e.target.value))}
                className="post-slider"
            />
            </div>

            <div className="api-toggle">
            <label>
                <input
                type="checkbox"
                checked={useAxios}
                onChange={(e) => setUseAxios(e.target.checked)}
                />
                Использовать axios (вместо fetch)
            </label>
            </div>

            <button onClick={reloadPosts} className="reload-btn">
            Обновить посты
            </button>
        </div>

        {loading && <div className="loading">Загрузка...</div>}
        {error && <div className="error">Ошибка: {error}</div>}

        <div className="posts-list">
            {displayedPosts.map(post => (
            <div key={post.id} className="post-card">
                <h3 className="post-title">{post.title}</h3>
                <p className="post-body">{post.body}</p>
                <div className="post-meta">
                <span>ID пользователя: {post.userId}</span>
                <span>ID поста: {post.id}</span>
                </div>
            </div>
            ))}
        </div>
        </div>
    );
}

export default Posts;